<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or issue }}</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
</head>
<body class="viewer-page">
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="../">
        <img src="../logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none'">
      </a>
      <nav class="nav">
        <a href="../index.html">Index</a>
        <a href="../about.html">About</a>
      </nav>
    </div>
  </header>

  <!-- Centered logo that follows header visibility -->
  <div class="center-logo" aria-hidden="true">
    <img src="../logo.png" alt="" onerror="this.parentElement.style.display='none'">
  </div>

  <!-- Floating header toggle (visible even when header is hidden) -->
  <button class="header-fab" id="headerFab" aria-label="Toggle header" aria-expanded="false">
    <span class="chevron" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </span>
  </button>

  <main class="viewer">
    <h1 class="visually-hidden">{{ arc }} {% if cycle %}â€” {{ cycle }}{% endif %}</h1>
    <div class="viewer-viewport">
      <div class="swiper main" id="mainSwiper">
        <div class="swiper-wrapper">
          {% for page in pages %}
          <div class="swiper-slide">
            <picture>
              <source type="image/webp" srcset="{{ page.webp }}">
              <img src="{{ page.file }}" alt="Page {{ loop.index }} of {{ title }}">
            </picture>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="thumbs-bar">
      <button class="thumbs-toggle" id="thumbsToggle" aria-label="Toggle pages" aria-expanded="false">
        <span class="chevron chevron-up" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M6 15l6-6 6 6"/></svg>
        </span>
        Pages
      </button>
    </div>

    <div class="swiper thumbs" id="thumbsSwiper" aria-label="Pages navigation">
      <div class="swiper-wrapper">
        {% for page in pages %}
        {% set i = loop.index0 %}
        {% set n = pages | length %}
        {% if i == 0 %}
          {% set label = 'cover' %}
        {% elif i == n - 1 %}
          {% set label = 'end page' %}
        {% elif i == 1 %}
          {% set label = '00' %}
        {% else %}
          {% set pair_index = ((i - 2) // 2) %}
          {% set first_num = pair_index * 2 + 1 %}
          {% set second_num = first_num + 1 %}
          {% if first_num < 10 %}
            {% set first_str = '0' ~ first_num %}
          {% else %}
            {% set first_str = '' ~ first_num %}
          {% endif %}
          {% if second_num < 10 %}
            {% set second_str = '0' ~ second_num %}
          {% else %}
            {% set second_str = '' ~ second_num %}
          {% endif %}
          {% set label = first_str ~ '-' ~ second_str %}
        {% endif %}
        <div class="swiper-slide">
          <div class="thumb-item">
            <img src="thumbs/{{ page.file }}" alt="Thumb {{ loop.index }}">
            <div class="thumb-label">{{ label }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </main>

  <!-- Overlay navigation arrows (must exist before Swiper init) -->
  <button class="nav-arrow prev" aria-label="Previous page">
    <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg>
  </button>
  <button class="nav-arrow next" aria-label="Next page">
    <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg>
  </button>

  <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
  <script>
    // Header collapse toggle via floating button
    const headerFab = document.getElementById('headerFab');
    function setHeader(collapsed) {
      document.body.classList.toggle('nav-collapsed', !!collapsed);
      headerFab?.setAttribute('aria-expanded', String(!collapsed));
    }
    headerFab?.addEventListener('click', () => {
      setHeader(!document.body.classList.contains('nav-collapsed'));
    });

    // Swiper setup
    const thumbs = new Swiper('#thumbsSwiper', {
      slidesPerView: 'auto',
      freeMode: true,
      spaceBetween: 10,
      watchSlidesProgress: true,
      grabCursor: true,
      mousewheel: { forceToAxis: true, releaseOnEdges: true },
    });
    const main = new Swiper('#mainSwiper', {
      thumbs: { swiper: thumbs },
      slidesPerView: 1,
      centeredSlides: false,
      spaceBetween: 0,
      navigation: { nextEl: '.nav-arrow.next', prevEl: '.nav-arrow.prev' },
    });
  </script>

  <script>

    // Thumbnails toggle
    const thumbsToggle = document.getElementById('thumbsToggle');
    function setThumbs(hidden) {
      document.body.classList.toggle('thumbs-hidden', !!hidden);
      thumbsToggle.setAttribute('aria-expanded', String(!hidden));
    }
    thumbsToggle?.addEventListener('click', () => {
      setThumbs(!document.body.classList.contains('thumbs-hidden'));
      setTimeout(() => { main.update(); thumbs.update(); }, 200);
    });

    // Default states on issue page
    setHeader(false); // keep header visible by default
    setThumbs(true);  // hide pages navigation by default

    // Keyboard navigation
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { e.preventDefault(); main.slidePrev(); }
      if (e.key === 'ArrowRight') { e.preventDefault(); main.slideNext(); }
    });
  </script>
</body>
</html>
